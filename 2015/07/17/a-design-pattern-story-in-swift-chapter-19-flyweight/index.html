<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      A Design Pattern Story in Swift – Chapter 19: Flyweight &middot; Audrey Li's Personal Blog
    
  </title>

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <link rel='stylesheet' href='http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css'>

  <link rel="stylesheet" type="text/css" href="/assets/bootstrap/css/bootstrap-theme.css">
  <link rel="stylesheet" type="text/css" href="/assets/bootstrap/css/bootstrap.css">

 
  <!-- CSS -->
  <!-- build:css /assets/stylesheets/style.min.css -->
  <link rel="stylesheet" href="/assets/stylesheets/style.css">
  <!-- endbuild -->
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=RobotoDraft:100,300,400|Roboto:300,300italic,400">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="/assets/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/assets/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/assets/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/assets/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/assets/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/assets/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/assets/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/assets/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/assets/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/assets/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/assets/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/assets/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/assets/images/favicons/manifest.json">
  <meta name="apple-mobile-web-app-title" content="Audrey's Blog">
  <meta name="application-name" content="Audrey's Blog">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/assets/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

</head>

  
  <body>
    <nav id="push_sidebar">
    <ul>
      <li><a href="/">Home</a></li>
      <li><a href="#">Portfolio</a></li>
      <li><a href="/archive">Archive</a></li>
      <li><a href="/about">About</a></li>
    </ul>
    
    <div class="social-icons">
        <img src="/assets/images/audrey-li.jpg" alt="Audrey's Photo" class="img-circle">

        <a href="https://github.com/vidaaudrey" title="Audrey's Github">
            <span class="fa-stack fa-lg">
              <i class="fa fa-circle fa-stack-2x"></i>
              <i class="fa fa-github fa-stack-1x fa-inverse"></i>
            </span>

        <a href="https://www.facebook.com/audreyauli" title="Audrey's Facebook">
            <span class="fa-stack fa-lg">
              <i class="fa fa-circle fa-stack-2x"></i>
              <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
            </span>
        </a>
    
        <a href="https://google.com/+AudreyLiSF" title="Audrey's Google Plus">
            <span class="fa-stack fa-lg">
              <i class="fa fa-circle fa-stack-2x"></i>
              <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
            </span>
        </a>

        <a href="https://www.linkedin.com/in/audreyauli" title="Audrey's Google Plus">
            <span class="fa-stack fa-lg">
              <i class="fa fa-circle fa-stack-2x"></i>
              <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
            </span>
        </a>
        
        <a href="/assets/images/wechat.jpg" title="Audrey's Wechat">
            <span class="fa-stack fa-lg">
              <i class="fa fa-circle fa-stack-2x"></i>
              <i class="fa fa-weixin fa-stack-1x fa-inverse"></i>
            </span>
        </a>

    </div>

</nav>

    <div id="body-wrap">
      <header class="nav-down"  id="wrapper">
    <a class="navbar-brand" href="/"><img alt="Brand" src="/assets/images/normal/logo-dark-round.png"></a>

    <div class="container-fluid">
       <span class="nav_trigger"><span class="glyphicon glyphicon-menu-hamburger"></span></span>
    </div>
</header>
      

<!-- jumbotron for pages -->

<!-- jumbotron for post page, with feature image -->
  
      <div class="jumbotron jumbotron-post" style="background-image: url('/assets/wp-content/uploads/2015/07/army1.jpg')">
         <div class="fullwidth-wrapper">
    <div class="col-md-8 col-md-offset-2 col-sm-10 col-sm-offset-1 col-xs-12 ">
      <div class="main-wrap">
           <h2 class="post-title">A Design Pattern Story in Swift – Chapter 19: Flyweight</h2>
            <p class="post-date">17 Jul 2015</p>
      </div>
    </div>
</div>
        
      </div>

  <!-- jumbotron for post page, without feature image -->
  






      <main class="row">
          <div class="col-md-8 col-md-offset-2 col-sm-10 col-sm-offset-1 col-xs-12 ">
              <div class="main-wrap">
                <div class="post">
   <div class="page" title="Page 333">
  <div class="layoutArea">
    <div class="column">
      <p>
        It&#8217;s hard to get things done without a system to share and prioritize.  There are thousands of soldiers in the army, but only few of them are commanders. How can we quickly go through all the soldiers to find the commanders, their ranks, and how much power the army has together?
      </p>
      
      <blockquote>
        <p>
          The flyweight pattern shares common data objects between multiple calling components.  It reduces the amount of memory needed to create the data objects required by the calling components and the amount of work required to create them. The impact of implementing the pattern increases with the number of calling components that share the data.  <em><a href="http://www.apress.com/9781484203958">Design Pattern in Swift</a> (The code is also referred by the book)</em>
        </p>
      </blockquote>
    </div>
  </div>
</div>

<div class="highlight"><pre><code class="language-swift" data-lang="swift">struct Soldier{
    let name: String
    let id: Int
    var rank: Int
    var hashValue: Int { return name.hashValue }
}

func == (lhs: Soldier, rhs: Soldier) -&amp;gt; Bool {
    return lhs.id == rhs.id &amp;&amp; lhs.name == rhs.name
}

extension Dictionary {
    init(setupFunc: (() -&amp;gt; [(Key, Value)])){
        self.init()
        for item in setupFunc() {
            self[item.0] = item.1
        }
    }
}

protocol Flyweight {
    subscript(id: Int) -&amp;gt; Soldier? { get set }
    var totalPower: Int { get }
    var numberOfCommanders: Int { get }
}

//: There are thousands of soldiers in the army, most of which are lower level soldiers, but some are commanders with higher rank
//: extrinsic holds all soldiers, intrinsic represent those who are commanders (who&#39;s rank has been updated to higher level).

class ArmyFlyweight: Flyweight {
    private let extrinsicArmy: [Int: Soldier]
    private var intrinsicArmy: [Int: Soldier]
    private let queue = dispatch_queue_create(&quot;dataQ&quot;, DISPATCH_QUEUE_CONCURRENT)
    
    init(soldiers: [Int: Soldier]) {
        self.extrinsicArmy = soldiers
        self.intrinsicArmy = [:]
    }
    
    subscript(id: Int) -&amp;gt; Soldier? {
        get {
            var result: Soldier?
            dispatch_sync(queue) { () -&amp;gt; Void in
                guard let soldier = self.intrinsicArmy[id] else {
                    result =  self.extrinsicArmy[id]
                    return
                }
                result = soldier
            }
            return result
        }
        set(newSoldier) {
            if newSoldier != nil {
                dispatch_sync(queue) { () -&amp;gt; Void in
                    self.intrinsicArmy[id] = newSoldier
                }
            }
        }
    }
    
    // each of the soldier&#39;s power = rank * rank, initial rank for soliders is 0.
    var totalPower: Int {
        var result = 0
        dispatch_sync(queue) { () -&amp;gt; Void in
            result = self.intrinsicArmy.values.map{$0.rank * $0.rank}.reduce(0, combine: +)
        }
        return result
    }
    var numberOfCommanders: Int {
        var result = 0
        dispatch_sync(queue) { () -&amp;gt; Void in
            result = self.intrinsicArmy.count
        }
        return result
    }
    
}


class FlyweightFactory {
    static var numberOfSoldiers: Int = 10 {
        didSet {
            print(&quot;Set the total number of soldiers to be \(numberOfSoldiers)&quot;)
        }
    }
    class func createFlyweight() -&amp;gt; Flyweight {
        return ArmyFlyweight(soldiers: extrinsicArmy)
    }
    
    private class var extrinsicArmy: [Int: Soldier] {
        get {
            struct singletonWrapper {
                static let singleton = Dictionary&amp;lt;Int, Soldier&amp;gt;(
                    setupFunc: { () in
                        var results:[(Int, Soldier)] = []
                        for i in 0..&amp;lt;FlyweightFactory.numberOfSoldiers {
                            results.append(i, Soldier(name: &quot;Sol#\(i)&quot;, id: i, rank: 0))
                        }
                        return results
                    }
                    
                )
            }
            return singletonWrapper.singleton
        }
    }
}

class Army: CustomStringConvertible {
    private var soldiers: Flyweight
    init(){
        soldiers = FlyweightFactory.createFlyweight()
        print(&quot;Army created!&quot;)
    }
    var description: String {
        return &quot;Total soldiers: \(FlyweightFactory.numberOfSoldiers). Total commanders: \(numberOfCommanders). Total Power:\(totalPower) \n&quot;
    }
    func setRankBySoldier(var soldier: Soldier, newRank: Int){
        print(&quot;Setting \(soldier.name)&#39;s rank to be \(newRank)&quot;)
        soldier.rank = newRank
        soldiers[soldier.id] = soldier
    }
    func getSoliderById(id: Int) -&amp;gt; Soldier? {
        return soldiers[id]
    }
    
    func setRankById(id: Int, newRank: Int){
        if var oldSoldier = soldiers[id] {
            print(&quot;Setting \(oldSoldier.name)&#39;s rank to be \(newRank)&quot;)
            oldSoldier.rank = newRank
            soldiers[oldSoldier.id] = oldSoldier
        } else {
            print(&quot;Failed! Trying to set rank to an unknown soldier whose id is \(id)&quot;)
        }
    }
    func getCommanderNames() -&amp;gt; String {
        print(&quot;Trying to get commanders&#39; names&quot;)
        guard let s = soldiers as? ArmyFlyweight else { return &quot;Failed to get commanders&#39; names&quot; }
        return s.intrinsicArmy.values.map{$0.name}.reduce(&quot;&quot;){ $0 + &quot;  &quot; + $1}
    }
    var totalPower: Int { return soldiers.totalPower }
    var numberOfCommanders: Int { return soldiers.numberOfCommanders }
}

//: Testing
let totalNumberOfSoldiers = 20000
FlyweightFactory.numberOfSoldiers = totalNumberOfSoldiers
let army1 = Army()
print(army1.description)
let sol1 = army1.getSoliderById(2)

for i in 1...10 {
    army1.setRankById(Int(arc4random_uniform(24000)) , newRank: Int(arc4random_uniform(10)) + 1)
}

army1.setRankBySoldier(sol1!, newRank: 4)
print(army1.description)
print(army1.getCommanderNames())

print(&quot;\n\n&quot;)&#39;</code></pre></div>

<p><a href="/assets/wp-content/uploads/2015/07/Flyweight.png"><img class="aligncenter size-full wp-image-1074" src="/assets/wp-content/uploads/2015/07/Flyweight.png" alt="Flyweight" width="647" height="326" /></a></p>

 </div>
 <div class="related">
   <h2>Related Posts</h2>
   <ul class="related-posts">
     
       <li>
         <h3>
           <a href="/2015/07/18/a-design-pattern-story-in-swift-chapter-21-interpretor/">
             A Design Pattern Story in Swift – Chapter 21: Interpretor
             <small>18 Jul 2015</small>
           </a>
         </h3>
       </li>
     
       <li>
         <h3>
           <a href="/2015/07/18/a-design-pattern-story-in-swift-chapter-20-mediator/">
             A Design Pattern Story in Swift – Chapter 20: Mediator
             <small>18 Jul 2015</small>
           </a>
         </h3>
       </li>
     
       <li>
         <h3>
           <a href="/2015/07/15/a-design-pattern-story-in-swift-chapter-18-visitor/">
             A Design Pattern Story in Swift – Chapter 18: Visitor
             <small>15 Jul 2015</small>
           </a>
         </h3>
       </li>
     
   </ul>
 </div>
 <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'audreyli';
    
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
      
    




              </div>
          </div>
          
      </main>

      <footer class="row">
    <div class="col-md-8 col-md-offset-2 text-center">
        &copy Copyright 2015 &nbsp; &nbsp; AudreyLi.me &nbsp; &nbsp;<a href="mailto:me@audreyli.me">Get in touch</a>
    </div>
    
</footer>


      <!-- Latest compiled and minified JavaScript -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

<!-- JS -->
<!-- build:js /assets/javascript/all.min.js -->
<script src="/assets/javascript/javascript.js"></script> 
<script src="/assets/javascript/main.js"></script> 
<!-- endbuild -->
  </div>
  </body>
</html>
